# Local Development Infrastructure for Card Fraud Rule Engine
#
# RECOMMENDED: Use card-fraud-platform for shared infrastructure instead.
#   cd ../card-fraud-platform && uv run platform-up
#
# This compose file is kept as a FALLBACK for standalone development.
# Container names match the shared platform so scripts work with either.
#
# Usage:
#   uv run redis-local-up          # Start Redis (checks platform first)
#   uv run redis-local-verify      # Verify Redis setup
#   uv run infra-local-up          # Start all (Redis + Redpanda)
#   uv run infra-local-down        # Stop all
#
# Load Testing:
#   docker compose -f docker-compose.yml --profile load-testing up
#   This starts: Redis + Redpanda + Rule Engine + Locust
#
# Connection strings (set in Doppler 'local' config):
#   REDIS_URL=redis://:@localhost:6379
#   KAFKA_BOOTSTRAP_SERVERS=localhost:9092 (external) or redpanda:29092 (internal)

services:
  redis:
    image: redis:8.4-alpine
    container_name: card-fraud-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - card-fraud-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    # Performance tuning for 10K TPS
    # Disable RDB saves for velocity counters (ephemeral data) via --save ""
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --maxclients 10000
      --save ""

  redpanda:
    image: redpandadata/redpanda:v24.3.11
    container_name: card-fraud-redpanda
    ports:
      - "9092:9092"
      - "9644:9644"
    volumes:
      - redpanda_data:/var/lib/redpanda
    networks:
      - card-fraud-network
    command: >
      redpanda start
      --kafka-addr internal://0.0.0.0:29092,external://0.0.0.0:9092
      --advertise-kafka-addr internal://redpanda:29092,external://localhost:9092
      --pandaproxy-addr 0.0.0.0:8082
      --advertise-pandaproxy-addr localhost:8082
      --rpc-addr 0.0.0.0:33145
      --advertise-rpc-addr localhost:33145
      --schema-registry-addr 0.0.0.0:8381
      --smp 1
      --memory 1G
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 10s
      retries: 10

  # ============================================
  # Load Testing Profile (Rule Engine + Locust)
  # ============================================
  rule-engine:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: card-fraud-rule-engine
    ports:
      - "8081:8081"
    environment:
      # Infrastructure
      - REDIS_URL=redis://:@redis:6379
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:29092
      # Quarkus configuration
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=8081
      - QUARKUS_LOG_LEVEL=INFO
      # S3/MinIO for ruleset artifacts
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-http://host.docker.internal:9000}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-fraud-gov-artifacts}
      - S3_REGION=${S3_REGION:-us-east-1}
    networks:
      - card-fraud-network
    depends_on:
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/v1/evaluate/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    profiles:
      - load-testing

  locust:
    image: locustio/locust:2.32.2
    container_name: card-fraud-locust
    ports:
      - "8089:8089"
    volumes:
      - ./load-testing:/locust
    environment:
      - TARGET_HOST=http://rule-engine:8081
    command: -f /locust/locustfile.py --host=http://rule-engine:8081
    networks:
      - card-fraud-network
    depends_on:
      rule-engine:
        condition: service_healthy
    profiles:
      - load-testing

volumes:
  redis_data:
  redpanda_data:

networks:
  card-fraud-network:
    name: card-fraud-network
    driver: bridge
